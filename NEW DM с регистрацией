import logging
import requests
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.fsm.state import StatesGroup, State
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.fsm.context import FSMContext
from aiogram import F

BOT_TOKEN = "–¢–í–û–ô_–¢–û–ö–ï–ù_–ë–û–¢–ê"

# üëâ –¢–í–û–ô –ù–û–í–´–ô Google Apps Script URL
GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw-1sEGiOIqIpHpjIPLB8LmaBnystny3iTZ7wHxVlezr0ttzDhk45Lf30VG8MRb5V2akQ/exec"

logging.basicConfig(level=logging.INFO)

bot = Bot(token=BOT_TOKEN)
dp = Dispatcher(storage=MemoryStorage())

# –ü–∞–º—è—Ç—å –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –≤–≤–æ–¥–∏–ª–∏ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ
users_data = {}

class Form(StatesGroup):
    fio = State()
    position = State()
    department = State()
    suggestion = State()


@dp.message(Command("start"))
async def cmd_start(message: types.Message, state: FSMContext):

    # –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ —É–∂–µ –∑–∞–ø–æ–ª–Ω—è–ª –§–ò–û/–¥–æ–ª–∂–Ω–æ—Å—Ç—å/–æ—Ç–¥–µ–ª
    if message.from_user.id in users_data:
        await message.answer("–ù–∞–ø–∏—à–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:")
        await state.set_state(Form.suggestion)
    else:
        await message.answer("–ü—Ä–∏–≤–µ—Ç! –î–∞–≤–∞–π –ø–æ–∑–Ω–∞–∫–æ–º–∏–º—Å—è üòä\n\n–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –§–ò–û:")
        await state.set_state(Form.fio)


@dp.message(Form.fio)
async def process_fio(message: types.Message, state: FSMContext):
    await state.update_data(fio=message.text)
    await message.answer("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É –¥–æ–ª–∂–Ω–æ—Å—Ç—å:")
    await state.set_state(Form.position)


@dp.message(Form.position)
async def process_position(message: types.Message, state: FSMContext):
    await state.update_data(position=message.text)
    await message.answer("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–¥–µ–ª:")
    await state.set_state(Form.department)


@dp.message(Form.department)
async def process_department(message: types.Message, state: FSMContext):
    await state.update_data(department=message.text)

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–∞–º—è—Ç—å
    users_data[message.from_user.id] = await state.get_data()

    await message.answer("–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å –Ω–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:")
    await state.set_state(Form.suggestion)


@dp.message(Form.suggestion)
async def process_suggestion(message: types.Message, state: FSMContext):
    user_id = message.from_user.id

    if user_id not in users_data:
        await message.answer("–û—à–∏–±–∫–∞ ‚Äî –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ. –í–≤–µ–¥–∏—Ç–µ /start")
        return

    base = users_data[user_id]

    data = {
        "fio": base["fio"],
        "position": base["position"],
        "department": base["department"],
        "suggestion": message.text
    }

    try:
        response = requests.post(GOOGLE_SCRIPT_URL, data=data)

        if response.status_code == 200:
            await message.answer("–í–∞—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! ‚úÖ")
        else:
            await message.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ ‚ùå")
    except Exception as e:
        await message.answer("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ ‚ùå")

    await state.clear()


if __name__ == "__main__":
    dp.run_polling(bot)
