import logging
import requests
from aiogram import Bot, Dispatcher, F
from aiogram.types import Message
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.context import FSMContext
from aiogram import Router

BOT_TOKEN = "–í–ê–®_–¢–û–ö–ï–ù"
SCRIPT_URL = "–í–ê–®_–ê–î–†–ï–°_–°–ï–†–í–ò–°–ê"

bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()
router = Router()
dp.include_router(router)

# ---------------------------- FSM ---------------------------- #

class Form(StatesGroup):
    fio = State()
    job = State()
    department = State()
    proposal = State()

# ---------------------------- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---------------------------- #

def check_user_exists(user_id: int):
    """–ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ Google Sheets"""
    try:
        resp = requests.get(SCRIPT_URL, params={"check": user_id})
        if resp.status_code == 200:
            return resp.json().get("exists", False)
    except:
        pass
    return False

# ---------------------------- –ö–æ–º–∞–Ω–¥—ã ---------------------------- #

@router.message(F.text == "/start")
async def cmd_start(message: Message, state: FSMContext):
    user_id = message.from_user.id

    if check_user_exists(user_id):
        await message.answer("–í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã! –ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:")
        await state.set_state(Form.proposal)
    else:
        await message.answer("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –§–ò–û:")
        await state.set_state(Form.fio)

# ---------------------------- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ---------------------------- #

@router.message(Form.fio)
async def process_fio(message: Message, state: FSMContext):
    await state.update_data(fio=message.text)
    await message.answer("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É –¥–æ–ª–∂–Ω–æ—Å—Ç—å:")
    await state.set_state(Form.job)

@router.message(Form.job)
async def process_job(message: Message, state: FSMContext):
    await state.update_data(job=message.text)
    await message.answer("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–¥–µ–ª:")
    await state.set_state(Form.department)

@router.message(Form.department)
async def process_department(message: Message, state: FSMContext):
    await state.update_data(department=message.text)
    await message.answer("–¢–µ–ø–µ—Ä—å –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:")
    await state.set_state(Form.proposal)

# ---------------------------- –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ ---------------------------- #

@router.message(Form.proposal)
async def process_proposal(message: Message, state: FSMContext):
    data = await state.get_data()

    # –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ ‚Äî –¥–∞–Ω–Ω—ã–µ —É–∂–µ –µ—Å—Ç—å.
    # –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω ‚Äî –Ω–∞–¥–æ –≤–∑—è—Ç—å –µ–≥–æ –¥–∞–Ω–Ω—ã–µ –∏–∑ Google Sheets.
    if not data.get("fio"):
        # –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí –±–µ—Ä—ë–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
        info = requests.get(SCRIPT_URL, params={"get": message.from_user.id}).json()
        data = info  # —Ç–∞–º –±—É–¥–µ—Ç fio, job, department

    # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø–∏—Å—å
    payload = {
        "user_id": message.from_user.id,
        "fio": data["fio"],
        "job": data["job"],
        "department": data["department"],
        "proposal": message.text
    }

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Google Sheets
    resp = requests.post(SCRIPT_URL, json=payload)

    if resp.status_code == 200:
        await message.answer("–í–∞—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ! –°–ø–∞—Å–∏–±–æ üòä")
    else:
        await message.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

    await state.clear()

# ---------------------------- –ó–∞–ø—É—Å–∫ ---------------------------- #

if __name__ == "__main__":
    logging.basicConfig(level=logging.INFO)
    dp.run_polling(bot)
